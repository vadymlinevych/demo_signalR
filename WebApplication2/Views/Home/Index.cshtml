@{
    ViewData["Title"] = "Home Page";
}

<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <p>Learn about <a href="https://learn.microsoft.com/aspnet/core">building Web apps with ASP.NET Core</a>.</p>
</div>

@section Scripts
{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        let confToken = "09bfec02-83da-4378-8cae-30826e190d42ff55a3bf-860d-4edd-833c-f3c1b9ef6957";

        document.cookie = `confirmation_token=${confToken}; path=/;`;
        const connection = new signalR.HubConnectionBuilder()
            .withUrl('http://localhost:5149/rocketmoneyHub', {
                transport: signalR.HttpTransportType.WebSockets,
                fetch: (url, options) => {
                    options.credentials = 'include';
                    return fetch(url, options);
                }
            })
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        connection.on('AuthorizeClient', (model) => {
            // Prepare data for POST request
            const data = {
                mobile: model.mobile,
                confirmationToken: model.confirmationToken
            };

            // Create JS fetch POST request
            fetch('http://localhost:5149/api/Authorization/authorize-by-token', {
                method: 'POST',
                   credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                console.log('Authorization response:', result);
            })
            .catch(error => {
                console.error('Authorization failed:', error);
            });
        });

        connection.start();
    </script>
}
